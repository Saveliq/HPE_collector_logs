# Сборщик логов серверов (`collect.py`)

Этот Python-скрипт собирает информацию о серверах, IML-логи и AHS-файлы с использованием Redfish API. Он обрабатывает несколько серверов параллельно, сохраняет данные в JSON- и AHS-файлы, а также ведет логи ошибок для отладки. Скрипт предназначен для системных администраторов, управляющих серверной инфраструктурой.

## Требования

Перед запуском скрипта убедитесь, что выполнены следующие условия:

### Системные требования
- **Операционная система**: Windows, Linux или macOS
- **Версия Python**: Python 3.6 или выше
- **Права доступа**: Право на запись в директорию, где будет создана папка `server_logs`
- **Сетевой доступ**: Доступ к серверам через HTTPS (порт 443) с использованием Redfish API

### Зависимости Python
Скрипт требует следующие Python-библиотеки:
- `redfish`: Для работы с Redfish API
- `urllib3`: Для выполнения HTTP-запросов
- Другие стандартные библиотеки (`json`, `csv`, `os`, `re`, `traceback`, `datetime`, `concurrent.futures`) включены в Python

Установите необходимую библиотеку с помощью pip:
```bash
pip install redfish
```

### Входной файл
- **Файл**: `servers.csv`
- **Расположение**: Та же директория, где находится `collect.py`
- **Формат**: CSV-файл в кодировке UTF-8 с колонками:
  - `ip`: IP-адрес сервера (например, `192.168.1.100`)
  - `username`: Имя пользователя для Redfish API
  - `password`: Пароль для Redfish API
- **Пример `servers.csv`**:
  ```csv
  ip,username,password
  192.168.1.100,admin,password123
  192.168.1.101,admin,password456
  ```
- **Примечания**:
  - Убедитесь, что CSV-файл содержит строку заголовка с полями `ip`, `username`, `password`.
  - Строки, в которых отсутствует хотя бы одно из этих полей, будут пропущены с предупреждением.
  - Используйте кодировку UTF-8, чтобы избежать ошибок декодирования.

## Установка

1. **Установите Python**:
   - Скачайте и установите Python 3.6+ с [python.org](https://www.python.org/downloads/).
   - Проверьте установку:
     ```bash
     python --version
     ```

2. **Установите зависимости**:
   - Установите библиотеку `redfish`:
     ```bash
     pip install redfish
     ```

3. **Подготовьте скрипт**:
   - Сохраните `collect.py` в рабочую директорию (например, `/path/to/script/`).
   - Поместите `servers.csv` в ту же директорию.

4. **Проверьте права доступа**:
   - Убедитесь, что у вас есть права на запись в директорию для создания папки `server_logs`.
   - На Linux/macOS может потребоваться выполнить:
     ```bash
     chmod +w /path/to/script/
     ```

## Использование

1. **Подготовьте `servers.csv`**:
   - Создайте или отредактируйте `servers.csv`, указав IP-адреса, имена пользователей и пароли серверов.
   - Пример:
     ```csv
     ip,username,password
     192.168.1.100,admin,password123
     192.168.1.101,admin,password456
     ```

2. **Запустите скрипт**:
   - Откройте терминал или командную строку.
   - Перейдите в директорию со скриптом:
     ```bash
     cd /path/to/script/
     ```
   - Выполните скрипт:
     ```bash
     python collect.py
     ```

3. **Настройте параллельную обработку**:
   - При появлении запроса введите количество одновременных процессов обработки серверов (потоков):
     ```
     Введите количество одновременных обработок (по умолчанию 10):
     ```
   - Введите положительное целое число или нажмите Enter, чтобы использовать значение по умолчанию (10).
   - Примечания:
     - Число ограничивается количеством серверов в `servers.csv`, чтобы избежать лишних потоков.
     - Большее значение увеличивает параллелизм, но может нагрузить систему или сеть.

4. **Отслеживайте вывод**:
   - Скрипт будет отображать прогресс для каждого сервера:
     ```
     Обработка сервера 192.168.1.100 начата
     Сбор данных начат
     Сбор данных завершен
     Обработка сервера 192.168.1.100 завершена, данные сохранены в server_logs/CZJ442026K_20250427_164404
     Обработано 1 из 2 серверов успешно
     ```
   - Ошибки для неудачных серверов отображаются:
     ```
     Ошибка при обработке сервера 192.168.1.101: ConnectionError: Connection timed out
     ```

5. **Проверьте результаты**:
   - **Выходная директория**: `server_logs` (создается в директории скрипта)
   - **Структура папок**:
     - Успешные серверы: `server_logs/{серийный_номер_или_ip}_{временная_метка}/`
     - Неудачные серверы: `server_logs/error_{ip}_{временная_метка}/`
   - **Файлы для каждого сервера**:
     - `server_info.json`: Необработанные данные Redfish
     - `parsed_data.json`: Обработанные данные Redfish
     - `IML_logs.json`: До 20 IML-логов
     - `{серийный_номер_или_ip}.ahs`: AHS-файл (если доступен)
     - `errors.log`: Лог операций и ошибок
   - **Резервные логи**: Если основная директория логов недоступна, логи сохраняются в `server_logs/fallback_errors_{ip}.log`.

6. **Проверьте итоговую статистику**:
   - Скрипт завершает работу с итоговой информацией:
     ```
     Обработка завершена: 1/2 серверов успешно обработано
     Сбой при обработке серверов: 192.168.1.101
     ```

## Устранение неполадок

### Распространенные проблемы
1. **"No such file or directory: servers.csv"**:
   - Убедитесь, что `servers.csv` находится в той же директории, что и `collect.py`.
   - Проверьте, что имя файла точно `servers.csv` (с учетом регистра на Linux).

2. **"UnicodeDecodeError" при чтении CSV**:
   - CSV-файл должен быть в кодировке UTF-8. Если используется другая кодировка (например, Windows-1251):
     - Преобразуйте файл в UTF-8 с помощью текстового редактора (например, Notepad++ или VS Code).
     - Пример в VS Code:
       1. Откройте `servers.csv`.
       2. Выберите "Сохранить с кодировкой" и выберите UTF-8.

3. **Ошибки соединения**:
   - **Симптомы**: Ошибки типа `ConnectionError: Connection timed out` или `InvalidCredentialsError`.
   - **Решения**:
     - Проверьте IP-адрес, имя пользователя и пароль в `servers.csv`.
     - Убедитесь, что сервер доступен (например, `ping 192.168.1.100`).
     - Проверьте, поддерживает ли сервер Redfish API и HTTPS (порт 443).

4. **Отказано в доступе**:
   - **Симптомы**: Ошибки типа `[Errno 13] Permission denied` при создании `server_logs`.
   - **Решения**:
     - Запустите скрипт с повышенными правами:
       ```bash
       sudo python collect.py
       ```
     - Измените права доступа к директории:
       ```bash
       chmod -R u+w /path/to/script/
       ```

5. **AHS-файл не создан**:
   - AHS-файл (`{серийный_номер_или_ip}.ahs`) создается только если сервер отвечает на запрос AHS.
   - Проверьте `errors.log` для деталей (например, `HTTP 404` или `ConnectionError`).
   - Убедитесь, что сервер поддерживает загрузку AHS через Redfish.

### Отладка
- **Проверка логов**:
  - Откройте `server_logs/{папка}/errors.log` для просмотра подробных сообщений об ошибках и стеков вызовов.
  - Пример записи в логе:
    ```
    2025-04-27 16:44:04.123456 - ERROR - Сервер 192.168.1.100 - Ошибка авторизации: InvalidCredentialsError: Invalid credentials
    ```
- **Включение подробного вывода**:
  - Измените методы `_log_error` и `_log_info` для вывода в консоль в реальном времени:
    ```python
    def _log_error(self, message):
        msg = f"{datetime.now()} - ERROR - Сервер {self.server_ip} - {message}"
        print(msg)
        ...
    ```

## Детали вывода

- **Успешные серверы**:
  - Папка: `server_logs/{серийный_номер_или_ip}_{ГГГГММДД_ЧЧММСС}/`
  - Файлы:
    - `server_info.json`: Полные данные Redfish
    - `parsed_data.json`: Обработанные данные Redfish
    - `IML_logs.json`: До 20 IML-логов
    - `{серийный_номер_или_ip}.ahs`: AHS-файл
    - `errors.log`: Лог операций и ошибок
- **Неудачные серверы**:
  - Папка: `server_logs/error_{ip}_{ГГГГММДД_ЧЧММСС}/`
  - Файлы: Частичные данные (например, `server_info.json`, `errors.log`), если они были собраны до ошибки
- **Резервные логи**:
  - Файл: `server_logs/fallback_errors_{ip}.log`
  - Используется, если основная директория логов недоступна

## Примечания

- **Параллелизм**: Скрипт использует несколько потоков (`max_workers`) для параллельной обработки серверов. Будьте осторожны с высокими значениями на системах с ограниченными ресурсами.
- **Безопасность**: Храните `servers.csv` в безопасном месте, так как он содержит конфиденциальные учетные данные.
- **Совместимость с Redfish**: Скрипт предполагает поддержку Redfish API v1. Убедитесь в совместимости с вашим оборудованием.
- **IML-логи**: Собираются только последние 20 IML-логов, как указано в `MAX_IML_LOGS`.

## Пример рабочего процесса

1. Создайте `servers.csv`:
   ```csv
   ip,username,password
   192.168.1.100,admin,password123
   192.168.1.101,admin,password456
   ```
2. Запустите скрипт:
   ```bash
   python collect.py
   ```
3. Введите `5` при запросе количества одновременных процессов.
4. Проверьте `server_logs` для результатов:
   - `server_logs/CZJ442026K_20250427_164404/` (успешно)
   - `server_logs/error_192.168.1.101_20250427_164405/` (неудачно)

## Лицензия

Скрипт предоставляется "как есть" без гарантий. Используйте на свой страх и риск.
